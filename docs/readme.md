# 지하철 노선도 관리 1, 2단계

## 기능 요구 사항

### 1. 역 관리 API

- [x] 역 생성
- [x] 중복 이름 역 생성 불가
- [x] 역 목록 조회
- [x] 역 단일 조회
- [x] 역 삭제

### 2. 노선 관리 API

- [x] 노선 생성
    - [x] 상행역,하행역,거리 필요
    - [x] 구간 정보도 함께 등록
- [x] 노선 목록 조회
- [x] 노선 단일 조회
    - [x] 상행종점에서 하행종점까지 역 목록 함께 반환
    - [x] 역 목록 정렬
- [x] 노선 수정
- [x] 노선 삭제

### 3. 구간 관리 API

- [x] 노선에 구간 추가
    - [x] 상/하행역,거리 필요
    - [x] 상행/하행역 중 **하나만** 노선에 등록되어 있어야 함
    - [x] 상/하행역 중 하나가 노선의 종점이라면 나머지 하나가 종점이 됨
    - 중간 추가
        - [x] 재배치: 기존 A2C => A1B 추가 => A1B - B1C
        - [x] **중간에 추가시** 기존의 구간보다 **거리가 작아야** 함
    - 예외 처리
        - [x] 상행/하행역 모두 노선에 존재O
        - [x] 상행/하행역 모두 노선에 존재X
        - [x] 중간에 추가시 새 구간의 길이가 기존 구간길이 이상(<=)
- [x] 구간 삭제
    - [x] 종점 제거시 그 다음역이 종점이 됨
    - 중간 제거
        - [x] 재배치: 기존 A1B - B1C => B 제거 -> A2C
    - 예외 처리
        - [x] 삭제하려는 역이 노선에 존재X
        - [x] 노선에 구간이 하나일 때

#### 구간 관리 플로우
- 구간 추가
    - 검증
        - 실패: 추가하려는 구간의 up, down 둘다 노선에 존재
        - 실패: 추가하려는 구간의 up, down 모두 노선에 없음
        - 실패: 중간에 추가시 기존구간보다 거리가 큼
    - 로직
        - 중간/종점 구분
            - 새구간과 up이 같거나(OR) down이 같은 구간 존재(둘 다 같을 순 없음) => 중간추가!
            - 결과가 1개 이상이면 중간 추가
        - 중간추가
            - 기존구간 = 위의 "중간/종점 구분" 쿼리 결과
            - 거리 검증
            - 구간 2개 생성
                - (1)새 구간
                - (2)구간(기존구간에서 한쪽 역id/(1)구간에서 한쪽 역id, 기존구간거리 - (1)구간거리)
            - 기존 구간 삭제
        - 종점추가
            - 새 구간 생성
- 구간 삭제
    - 검증
        - 실패: 노선에 구간이 하나밖에 없음
            - 결과가 2개 이상이면 통과
        - 실패: 역이 노선에 없음
          - 결과가 1개 이상이면 통과
    - 로직
        - 중간/종점 구분
            - 삭제하려는 station_id를 가지고 있는 구간 개수: 1개=종점 / 2개=중간
            - 구간개수 = 위의 "역이 노선에 없음" 쿼리 결과
        - 중간삭제
            - 새 구간 생성(양쪽 구간의 서로 반대쪽 역2개, 양쪽 구간 합친 거리)
            - 기존 양쪽 구간 삭제
        - 종점삭제
            - 삭제하려는 역을 가지고 있는 구간 삭제

### 예외 처리
- [x] 서비스에 종속적인 커스텀 예외 정의
- [x] Dao에서 발생한 DB예외를 서비스레이어에서 처리
- [x] 리소스 생성 요청시 요청데이터를 바로 리턴하지 말고 DB에서 다시 쿼리하도록 변경

### TODO
- [ ] 서비스에서 다른 서비스 호출하도록 변경
    - 상위 서비스는 하위 서비스만 참조
    - 하위 서비스는 DAO와 1대1 매핑
- [ ] 서비스계층이 도메인을 보호해야하나? (서비스에서 DTO를 반환?)
- [ ] 생성자 인자가 많은 곳에서 빌더 활용
- [ ] validation에 메시지 추가하기(@NotNull(message = "하행역 정보를 입력해야합니다."))
- [ ] SimpleJdbcInsert 적용하기
- [ ] 예외에 @ResponseStatus(HttpStatus.UNAUTHORIZED) 적용하기